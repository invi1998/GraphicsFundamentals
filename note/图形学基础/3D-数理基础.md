# 3D数理基础

- 了解OpenGL & ES的渲染流程
- 学习三维图形基本理论
- 掌握常用的三维数学方法，向量，矩阵
- 掌握模型矩阵，观察矩阵，投影矩阵

# 固定渲染管线

*图形渲染管道被认为是实时图形渲染的核心，简称为管道。管道的主要功能是由给定的虚拟摄像机、三维物体、灯源、光照模型、纹理贴图或其他来产生或渲染一个二维图像。由此可见，渲染管线是实时渲染技术的底层工具。图像中物体的位置及形状是通过它们的几何描述、环境特征、以及该环境中虚拟摄像机的摆放位置来决定的。物体的外观受到了材质属性、灯源、贴图以及渲染模式（\*sharding modles\*）的影响。*

**很多计算机图形学的书籍都把渲染管线分为三个阶段：应用程序阶段、几何阶段、光栅化阶段。**

**渲染管线是指为了在显示器上显示图像而经过的一系列必要操作，具体流程如下：**

1、自身坐标系

在自身坐标系中建模不像在世界坐标系中要考虑本物体相对于其他物体的位置、大小、方向关系。

 

2、世界坐标系

一旦我们构造了各种模型，它们都在自己的自身坐标系中，但是我们需要把它们都放到同一个世界坐标系中。物体从自身坐标系到世界坐标系中的变换叫做世界变换。世界变换通常是用平移、旋转、缩放操作来设置模型在世界坐标系中的位置、大小、方向。世界变换就是通过各物体在世界坐标系中的位置、大小和方向等相互之间的关系来建立所有物体。

 

3、视图坐标系

将照相机平移变换到世界坐标系的源点并把它的方向旋转至朝向Z轴的正方向，当然，世界坐标系中的所有物体都将随着照相机的变换而做相同的变换。这个变换就叫做视图坐标系变换。

 

4、背面拣选

一个多边形有两个表面，我们将一个标为正面，一个为背面。通常，后表面总是不可见的，这是因为场景中大多数物体是密封的。一个多边形的边都是面向照相机叫正面多边形，而一个多边形的边都背对照相机叫背面多边形。

正面多边形挡住了在它后面的背面多边形，Direct3D将通过拣选（即删除多余的处理过程）背面多边形来提高效率，这种方法就叫背面拣选。

顶点以顺时针方向（在观察坐标系中）形成的三角形为正面，以逆时针方向形成的三角形为背面。

 

5、光源

光源定义在世界坐标系中然后被变换到视图坐标系中。视图坐标系中光源给物体施加的光照大大增加了场景中物体的真实性。

 

6、裁剪

拣选那些超出了可视体范围的几何图形的过程就叫做裁剪。

 

7、投影

视图坐标系的主要任务就是将3D场景转化为2D图像表示。这种从n维转换成n-1维的过程就叫做投影。投影的方法有很多种，但是我们只对一种特殊的投影感兴趣，那就是透视投影。因为透视投影可以使离照相机越远的物体投影到屏幕上后就越小，这可以使我们把3D场景更真实的转化为2D图像。

投影变换的实质就是定义可视体，并将可视体内的几何图形投影到投影窗口上去。

 

8、视口变换

视口变换主要是转换投影窗口到显示屏幕上。通常一个游戏的视口就是整个显示屏，但是当我们以窗口模式运行的时候，也有可能只占屏幕的一部分或在客户区内。

 

9、光栅化

在把三角形每个顶点转换到屏幕上以后，我们就画了一个2D三角形。光栅化是计算需要显示的每个三角形中每个点颜色值。

光栅化过程是非常繁重的计算，它应该通过硬件图形处理来完成。它的处理结果就是把2D图象显示在显示器上。



## Object Coordinates 模型坐标系

模型坐标系，也叫Local坐标系，例如我们在3DMax，MAYA等建模工具中建立的我们的人物模型时，模型中的顶点坐标值就是Model坐标系的值。摄像我们有多个人物模型， 那么每个模型就有属于自己的model坐标系

## Eye Coordinates 摄像机坐标

Camera坐标系是人眼观察 world坐标系时，以人眼为原点，视线方向为Z轴建立的新坐标系，这个作案比欧西以观察者（眼睛）为中心，为视野裁剪和投影等做好铺垫，随着观察者眼睛位置的变换，或者视线方向的变化，camera坐标系也会同时发生变化



# 向量和矩阵

## **向量加减法：**

两向量a与b的和为一个向量，记为c，即   c = a + b

c与两向量a与b的关系遵循平行四边形法则。

设二维向量 P =(x1,y1)  , Q  = (x2 , y2),则向量的加法定义为：

                                                     P+Q = (x1+x2,y1+y2)

同理，向量减法为：

                                                     P-Q = （x1-x2,y1-y2)

  显然有性质：

                       P+Q=Q+P                    P-Q=-（Q-P）

 

## 向量的内积（点乘）

## 定义

概括地说，向量的**内积**（点乘/数量积）。对两个向量执行点乘运算，就是对这两个向量对应位一一相乘之后求和的操作，如下所示，对于向量a和向量b：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172346307-1203631679.png) ![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172347385-1655060695.png)

a和b的点积公式为：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172347932-1873667255.png)

这里要求一维向量a和向量b的行列数相同。**注意：点乘的结果是一个标量(数量而不是向量)**

**定义**：两个向量**a**与**b**的内积为 **a**·**b** = |**a**||**b**|cos∠(a, b)，特别地，**0**·**a** =**a**·**0** = 0；若**a**，**b**是非零向量，则**a**与**b\**\**正交**的充要条件是**a**·**b** = 0。

## 向量内积的性质：

1. **a**^2 ≥ 0；当**a**^2 = 0时，必有**a** = 0. （正定性）
2. **a**·**b** = **b**·**a**. （对称性）
3. (λ**a** + μ**b**)·**c** = λ**a**·**c** + μ**b**·**c**，对任意实数λ, μ成立. （线性）
4. cos∠(**a**,**b**) =**a**·**b**/(|**a**||**b**|).
5. |**a**·**b**| ≤ |**a**||**b**|，等号只在**a**与**b**共线时成立.

## 向量内积的几何意义

内积（点乘）的几何意义包括：

1. 表征或计算两个向量之间的夹角
2. b向量在a向量方向上的投影

有公式：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172348479-484610832.png)

推导过程如下，首先看一下向量组成：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172349104-213873300.png)

定义向量**c**：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172350104-715987855.png)

根据三角形余弦定理（这里a、b、c均为向量，下同）有：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172350495-1596303032.png)

根据关系**c**=**a**-**b**有：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172351182-1041160445.png)

即：

a∙b=|a||b|cos⁡(θ)

向量a，b的长度都是可以计算的已知量，从而有a和b间的夹角θ：

θ=arccos⁡(a∙b|a||b|)

进而可以进一步判断两个向量是否同一方向或正交(即垂直)等方向关系，具体对应关系为：

a∙b>0→方向基本相同，夹角在0°到90°之间
a∙b=0→ 正交，相互垂直
a∙b<0→ 方向基本相反，夹角在90°到180°之间

## 向量的外积（叉乘）

## 定义

概括地说，两个向量的外积，又叫叉乘、叉积向量积，其运算结果是一个**向量**而不是一个标量。并且两个向量的外积与这两个向量组成的坐标平面垂直。

**定义**：向量**a**与**b**的外积**a**×**b**是一个向量，其长度等于|**a**×**b**| = |**a**||**b**|sin∠(**a**,**b**)，其方向正交于**a**与**b**。并且，(**a**,**b**,**a**×**b**)构成右手系。
特别地，**0**×**a** = **a**×**0** = **0**.此外，对任意向量**a**，**a**×**a**=**0**。

对于向量a和向量b：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172351839-750620972.png)

a和b的外积公式为：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172352292-327320233.png)

其中：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172352667-41569494.png)

根据i、j、k间关系，有：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172353057-1423174374.png)

## 向量外积的性质

1. **a** × **b** = -**b** × **a**. （反称性）
2. (λ**a** + μ**b**) × **c** = λ(**a** ×**c**) + μ(**b** ×**c**). （线性）

## 向量外积的几何意义

在三维几何中，向量a和向量b的外积结果是一个向量，有个更通俗易懂的叫法是**法向量**，该向量垂直于a和b向量构成的平面。

在3D图像学中，外积的概念非常有用，可以通过两个向量的外积，生成第三个垂直于a，b的法向量，从而构建X、Y、Z坐标系。如下图所示：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172353432-1363637045.png)

在二维空间中，外积还有另外一个几何意义就是：|**a**×**b**|在数值上等于由向量a和向量b构成的平行四边形的面积。

***叉积的作用**：*

叉积时一个非常重要的性质是可以通过它的符号判断两向量相互之间的顺逆时针关系：

若P×Q > 0 , 则P在Q的顺时针方向；

若P×Q < 0 , 则P在Q的逆时针方向；

若P×Q = 0 , P与Q共线，可能是同向也可能是反向；