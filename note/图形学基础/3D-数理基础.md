# 3D数理基础

- 了解OpenGL & ES的渲染流程
- 学习三维图形基本理论
- 掌握常用的三维数学方法，向量，矩阵
- 掌握模型矩阵，观察矩阵，投影矩阵

# 固定渲染管线

*图形渲染管道被认为是实时图形渲染的核心，简称为管道。管道的主要功能是由给定的虚拟摄像机、三维物体、灯源、光照模型、纹理贴图或其他来产生或渲染一个二维图像。由此可见，渲染管线是实时渲染技术的底层工具。图像中物体的位置及形状是通过它们的几何描述、环境特征、以及该环境中虚拟摄像机的摆放位置来决定的。物体的外观受到了材质属性、灯源、贴图以及渲染模式（\*sharding modles\*）的影响。*

**很多计算机图形学的书籍都把渲染管线分为三个阶段：应用程序阶段、几何阶段、光栅化阶段。**

**渲染管线是指为了在显示器上显示图像而经过的一系列必要操作，具体流程如下：**

1、自身坐标系

在自身坐标系中建模不像在世界坐标系中要考虑本物体相对于其他物体的位置、大小、方向关系。

 

2、世界坐标系

一旦我们构造了各种模型，它们都在自己的自身坐标系中，但是我们需要把它们都放到同一个世界坐标系中。物体从自身坐标系到世界坐标系中的变换叫做世界变换。世界变换通常是用平移、旋转、缩放操作来设置模型在世界坐标系中的位置、大小、方向。世界变换就是通过各物体在世界坐标系中的位置、大小和方向等相互之间的关系来建立所有物体。

 

3、视图坐标系

将照相机平移变换到世界坐标系的源点并把它的方向旋转至朝向Z轴的正方向，当然，世界坐标系中的所有物体都将随着照相机的变换而做相同的变换。这个变换就叫做视图坐标系变换。

 

4、背面拣选

一个多边形有两个表面，我们将一个标为正面，一个为背面。通常，后表面总是不可见的，这是因为场景中大多数物体是密封的。一个多边形的边都是面向照相机叫正面多边形，而一个多边形的边都背对照相机叫背面多边形。

正面多边形挡住了在它后面的背面多边形，Direct3D将通过拣选（即删除多余的处理过程）背面多边形来提高效率，这种方法就叫背面拣选。

顶点以顺时针方向（在观察坐标系中）形成的三角形为正面，以逆时针方向形成的三角形为背面。

 

5、光源

光源定义在世界坐标系中然后被变换到视图坐标系中。视图坐标系中光源给物体施加的光照大大增加了场景中物体的真实性。

 

6、裁剪

拣选那些超出了可视体范围的几何图形的过程就叫做裁剪。

 

7、投影

视图坐标系的主要任务就是将3D场景转化为2D图像表示。这种从n维转换成n-1维的过程就叫做投影。投影的方法有很多种，但是我们只对一种特殊的投影感兴趣，那就是透视投影。因为透视投影可以使离照相机越远的物体投影到屏幕上后就越小，这可以使我们把3D场景更真实的转化为2D图像。

投影变换的实质就是定义可视体，并将可视体内的几何图形投影到投影窗口上去。

 

8、视口变换

视口变换主要是转换投影窗口到显示屏幕上。通常一个游戏的视口就是整个显示屏，但是当我们以窗口模式运行的时候，也有可能只占屏幕的一部分或在客户区内。

 

9、光栅化

在把三角形每个顶点转换到屏幕上以后，我们就画了一个2D三角形。光栅化是计算需要显示的每个三角形中每个点颜色值。

光栅化过程是非常繁重的计算，它应该通过硬件图形处理来完成。它的处理结果就是把2D图象显示在显示器上。



## Object Coordinates 模型坐标系

模型坐标系，也叫Local坐标系，例如我们在3DMax，MAYA等建模工具中建立的我们的人物模型时，模型中的顶点坐标值就是Model坐标系的值。摄像我们有多个人物模型， 那么每个模型就有属于自己的model坐标系

## Eye Coordinates 摄像机坐标

Camera坐标系是人眼观察 world坐标系时，以人眼为原点，视线方向为Z轴建立的新坐标系，这个作案比欧西以观察者（眼睛）为中心，为视野裁剪和投影等做好铺垫，随着观察者眼睛位置的变换，或者视线方向的变化，camera坐标系也会同时发生变化



# 向量和矩阵

## **向量加减法：**

两向量a与b的和为一个向量，记为c，即   c = a + b

c与两向量a与b的关系遵循平行四边形法则。

设二维向量 P =(x1,y1)  , Q  = (x2 , y2),则向量的加法定义为：

                                                     P+Q = (x1+x2,y1+y2)

同理，向量减法为：

                                                     P-Q = （x1-x2,y1-y2)

  显然有性质：

                       P+Q=Q+P                    P-Q=-（Q-P）

 



## 向量的内积（点乘）

## 定义

概括地说，向量的**内积**（点乘/数量积）。对两个向量执行点乘运算，就是对这两个向量对应位一一相乘之后求和的操作，如下所示，对于向量a和向量b：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172346307-1203631679.png) ![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172347385-1655060695.png)

a和b的点积公式为：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172347932-1873667255.png)

这里要求一维向量a和向量b的行列数相同。**注意：点乘的结果是一个标量(数量而不是向量)**

**定义**：两个向量**a**与**b**的内积为 **a**·**b** = |**a**||**b**|cos∠(a, b)，特别地，**0**·**a** =**a**·**0** = 0；若**a**，**b**是非零向量，则**a**与**b\**\**正交**的充要条件是**a**·**b** = 0。

## 向量内积的性质：

1. **a**^2 ≥ 0；当**a**^2 = 0时，必有**a** = 0. （正定性）
2. **a**·**b** = **b**·**a**. （对称性）
3. (λ**a** + μ**b**)·**c** = λ**a**·**c** + μ**b**·**c**，对任意实数λ, μ成立. （线性）
4. cos∠(**a**,**b**) =**a**·**b**/(|**a**||**b**|).
5. |**a**·**b**| ≤ |**a**||**b**|，等号只在**a**与**b**共线时成立.

## 向量内积的几何意义

内积（点乘）的几何意义包括：

1. 表征或计算两个向量之间的夹角
2. b向量在a向量方向上的投影

有公式：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172348479-484610832.png)

推导过程如下，首先看一下向量组成：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172349104-213873300.png)

定义向量**c**：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172350104-715987855.png)

根据三角形余弦定理（这里a、b、c均为向量，下同）有：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172350495-1596303032.png)

根据关系**c**=**a**-**b**有：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172351182-1041160445.png)

即：

a∙b=|a||b|cos⁡(θ)

向量a，b的长度都是可以计算的已知量，从而有a和b间的夹角θ：

θ=arccos⁡(a∙b|a||b|)

进而可以进一步判断两个向量是否同一方向或正交(即垂直)等方向关系，具体对应关系为：

a∙b>0→方向基本相同，夹角在0°到90°之间
a∙b=0→ 正交，相互垂直
a∙b<0→ 方向基本相反，夹角在90°到180°之间

## 向量的外积（叉乘）

## 定义

概括地说，两个向量的外积，又叫叉乘、叉积向量积，其运算结果是一个**向量**而不是一个标量。并且两个向量的外积与这两个向量组成的坐标平面垂直。

**定义**：向量**a**与**b**的外积**a**×**b**是一个向量，其长度等于|**a**×**b**| = |**a**||**b**|sin∠(**a**,**b**)，其方向正交于**a**与**b**。并且，(**a**,**b**,**a**×**b**)构成右手系。
特别地，**0**×**a** = **a**×**0** = **0**.此外，对任意向量**a**，**a**×**a**=**0**。

对于向量a和向量b：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172351839-750620972.png)

a和b的外积公式为：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172352292-327320233.png)

其中：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172352667-41569494.png)

根据i、j、k间关系，有：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172353057-1423174374.png)

## 向量外积的性质

1. **a** × **b** = -**b** × **a**. （反称性）
2. (λ**a** + μ**b**) × **c** = λ(**a** ×**c**) + μ(**b** ×**c**). （线性）

## 向量外积的几何意义

在三维几何中，向量a和向量b的外积结果是一个向量，有个更通俗易懂的叫法是**法向量**，该向量垂直于a和b向量构成的平面。

在3D图像学中，外积的概念非常有用，可以通过两个向量的外积，生成第三个垂直于a，b的法向量，从而构建X、Y、Z坐标系。如下图所示：

![img](https://images2017.cnblogs.com/blog/810440/201709/810440-20170926172353432-1363637045.png)

在二维空间中，外积还有另外一个几何意义就是：|**a**×**b**|在数值上等于由向量a和向量b构成的平行四边形的面积。

***叉积的作用**：*

叉积时一个非常重要的性质是可以通过它的符号判断两向量相互之间的顺逆时针关系：

若P×Q > 0 , 则P在Q的顺时针方向；

若P×Q < 0 , 则P在Q的逆时针方向；

若P×Q = 0 , P与Q共线，可能是同向也可能是反向；



## 矩阵



举例
$$
a=\begin{bmatrix} 
a & c\\
b & d\\
\end{bmatrix}
$$

$$
b=\begin{bmatrix} 
a1 & a2\\
b1 & b2\\
\end{bmatrix}
$$
一、矩阵加法
两个矩阵相加或相减，需要满足两个矩阵的列数和行数一致。

加法交换律：A + B = B + A
$$
a + b=\begin{bmatrix} 
a+a1 & b+a2\\
c+b1 & d+b2\\
\end{bmatrix}
$$
二、矩阵减法
$$
a - b=\begin{bmatrix} 
 a − a 1 & b − a 2\\
 c − b 1 & d − b 2\\ 
\end{bmatrix}
$$
三、矩阵乘法
两个矩阵A和B相乘，需要满足A的列数等于B的行数。
a矩阵的行元素乘以每一列然后相加作为新矩阵的行元素
$$
a * b=\begin{bmatrix} 
a ∗ a 1 + b ∗ b 1 & a ∗ a 2 + b ∗ b 2 \\
c ∗ a 1 + d ∗ b 1 & c ∗ a 2 + d ∗ b 2 \\
\end{bmatrix}
$$
矩阵乘法不满足交换律，但是满足分配率和结合律,也就是说AB不等于BA
(AB)C=A(BC)
(A+B)C=AC+BC
C(A+B)=CA+CB

g*(AB)=(gA)B=A(gB)
g属于实数

四、矩阵转置
a矩阵转置之后(行变成列，列变成行)
$$
a T =\begin{bmatrix} 
a & c \\
b & d \\
\end{bmatrix}
$$
转置性质：：

![在这里插入图片描述](https://img-blog.csdnimg.cn/2021042821172960.png)

五、逆矩阵
矩阵A的逆矩阵记作A’， A A’=A’A= I，I是单位矩阵。
先介绍一下矩阵的单位阵，就是单位矩阵是一个n×n矩阵，从左到右的对角线上的元素是1，其余元素都为0。
$$
c =\begin{bmatrix} 
1 & 0 \\
0 & 1 \\
\end{bmatrix}
\\
\\
d =\begin{bmatrix} 
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
$$


性质：ac=ca=a

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210428212538872.png)

六、对称矩阵
如果一个矩阵转置后等于原矩阵，那么这个矩阵称为对称矩阵。由定义可知，对称矩阵一定是方阵。一个矩阵转置和这个矩阵的乘积就是一个对称矩阵：

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210428212749100.png?x-oss-process=image/watermark,t_ype_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZWhlYzIwMTA=,size_16,color_FFFFFF,t_70)

七、矩阵性质总结
性质1：单位矩阵的行列式为 1 ，与之对应的是单位立方体的体积是 1。
性质 2：当两行进行交换的时候行列式改变符号。
性质 3：行列式是单独每一行的线性函数（其它行不变）。
性质4：矩阵中有俩行一样，矩阵的行列式为0。
性质 5：用矩阵的一行减去另一行的倍数，行列式不变。
性质 6：当矩阵的某一行全为零的时候，行列式为零。
性质 7：如果矩阵是三角形的，那么行列式等于对角线上元素的乘积。
$$
d =\begin{bmatrix} 
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
$$
性质 8：如果矩阵是可逆的那么矩阵的行列式不等于0，反之行列式为0

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210428213647240.png)

性质 10：转置矩阵的行列式不变



# 实现固定渲染管线



# 投影矩阵和观察矩阵的原理

## **模型矩阵**

我们必须考虑，当空间中点的位置会发生变化的时候，其坐标如何变化。考虑三种基本的变换：平移、旋转和缩放。

“变换”的含义就是，将点的初始位置的坐标P映射到平移、旋转、缩放后的位置坐标P’，即：
$$
\begin{bmatrix}
x\\
y\\
z\\
\end{bmatrix}
→
\begin{bmatrix}
x′\\y′\\z′\\
\end{bmatrix}
$$
**平移变换**是最简单的变换：
$$
\begin{bmatrix}
x′\\y′\\z′\\
\end{bmatrix}
=
\begin{bmatrix}
x\\
y\\
z\\
\end{bmatrix}
+
\begin{bmatrix}
tx\\ty\\tz
\end{bmatrix}
$$
**旋转变换**有一些复杂，先看在二维平面上的旋转变换：

![动图封面](https://pic3.zhimg.com/v2-424501f8af1bdc3f595bc007b899b19e_b.jpg)



很容易得到：

`x^′=xcos⁡θ−ysin⁡θ`

`y^′=xsin⁡θ+ysin⁡θ`

矩阵形式的表达更加简洁，后面大多使用这种形式：
$$
\begin{bmatrix}
x′\\y′\\
\end{bmatrix}
=
\begin{bmatrix}
cos⁡θ & −sin⁡θ \\ sin⁡θ & cos⁡θ\\
\end{bmatrix}

\begin{bmatrix}
x\\y\\
\end{bmatrix}
$$


**推广到三维空间中：**

点绕z轴旋转：
$$
\begin{bmatrix}
x′\\y′\\z′
\end{bmatrix}
=
\begin{bmatrix}
cos⁡θ & −sin⁡θ & 0 \\ sin⁡θ & cos⁡θ & 0\\ 0 & 0 & 1\\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\
\end{bmatrix}
$$


点绕x轴旋转：
$$

\begin{bmatrix}
x′\\y′\\z′
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 & 0\\
0 & csin⁡θ & −sin⁡θ \\
0 & sin⁡θ & cos⁡θ \\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\
\end{bmatrix}
$$


点绕y轴旋转：
$$
\begin{bmatrix}
x′\\y′\\z′
\end{bmatrix}
=
\begin{bmatrix}
csin⁡θ & 0 & −sin⁡θ \\
0 & 1 & 0\\
sin⁡θ& 0 & cos⁡θ \\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\
\end{bmatrix}
$$


绕指定的任意轴旋转变换是由几个绕坐标轴旋转变换和平移变换效果叠加而成的，后文会有详细叙述。

**缩放变换**也比较简单：
$$
\begin{bmatrix}
x′\\y′\\z′
\end{bmatrix}
=
\begin{bmatrix}
sx & 0 & 0\\
0 & sy & 0\\
0 & 0 & sz\\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\
\end{bmatrix}
$$
总结一下：平移变换，变换后点坐标等于初始位置点坐标加上一个平移向量；而旋转变换和缩放变换，变换后点坐标等于初始位置点坐标乘以一个变换矩阵。

P′=P+T,

P′=R⋅P,

P′=S⋅P



**齐次坐标**这天才的发明，**允许平移变换也表示成初始位置点坐标左乘一个变换矩阵的形式**。齐次坐标使用4个分量来表示三维空间中的点，前三个分量和普通坐标一样，第四个分量为1。
$$
\begin{bmatrix}
x\\y\\z
\end{bmatrix}
→
\begin{bmatrix}
x\\y\\z\\1\\
\end{bmatrix}
$$


平移变换巧妙地表示为：
$$
\begin{bmatrix}
x′\\y′\\z′\\1\\
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 & 0 & tx\\
0 & 1 & 0 & ty\\
0 & 0 & 1 & tz\\
0 & 0 & 0 & 1\\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\1\\
\end{bmatrix}
$$
旋转变换（以绕z轴旋转为例）和缩放变换相应为：
$$
\begin{bmatrix}
x′\\y′\\z′\\1\\
\end{bmatrix}
=
\begin{bmatrix}
cos⁡θ & −sin⁡θ & 0 & 0\\
sin⁡θ & cos⁡θ & 0 & 0\\
0 & 0 & 1 & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\1\\
\end{bmatrix}
$$

$$
\begin{bmatrix}
x′\\y′\\z′\\1\\
\end{bmatrix}
=
\begin{bmatrix}
sx & 0 & 0 & 0\\
0 & sy & 0 & 0\\
0 & 0 & sz & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}

\begin{bmatrix}
x\\y\\z\\1\\
\end{bmatrix}
$$

综上，在齐次坐标下三种基本变换实现了形式上的统一，这种形式的统一意义重大。

P′=T⋅P,P′=R⋅P,P′=S⋅P

矩阵有一个性质：

M⋅(A⋅B)=(M⋅A)⋅B

考虑一个点，先进行了一次平移变换，又进行了一次旋转变换，结合上面矩阵的性质，可知变换后的点P’为：

P=R⋅(T⋅P)=(R⋅T)⋅P

旋转矩阵和平移矩阵的乘积R·T也是一个4×4的矩阵，这个矩阵代表了一次平移变换和一次旋转变换效果的叠加；如果这个点还要进行变换，只要将新的变换矩阵按照顺序左乘这个矩阵，得到的新矩阵能够表示之前所有变换效果的叠加，将最初的点坐标左乘这个矩阵就能得到一系列变换后最终的点坐标，这个矩阵称为“**模型矩阵**”。一个模型矩阵乘以另一个模型矩阵得到的还是一个模型矩阵，表示先进行右侧模型矩阵代表的变换，再进行左侧模型矩阵代表的变换这一过程的效果之和，因此模型矩阵的乘法又可以认为是闭合的。
模型矩阵之所以称之为“模型矩阵”，是因为该矩阵与点的位置没有关系，仅仅包含了一系列变换的信息。而在三维世界中，一个模型里所有的顶点往往共享同一个变换，对应同一个模型矩阵，比如抛在空中的一个木块，运转机器的一个齿轮。

之前说到，考虑一个物体绕指定轴旋转，如以下这个变换：绕着过顶点（x，y，z）方向为（a，b，c）的轴旋转角度θ，利用多个变换的叠加构建绕任意轴旋转的变换矩阵。
首先将顶点（x，y，z）平移到原点，绕x轴旋转角度p使指定的旋转轴在x-z平面上，绕y轴旋转角度q使指定的旋转轴与z轴重合，绕指定旋转轴（也就是z轴）旋转角度θ，绕y轴旋转角度-q，绕x轴旋转角度-p,将顶点平移到向量（x，y，z），p和q的值由方向（a，b，c）决定。综上，变换矩阵为：
$$
R\begin{pmatrix}

\begin{bmatrix}
x\\
y\\
z\\
\end{bmatrix}

\begin{bmatrix}
a\\
b\\
c\\
\end{bmatrix}

θ

\end{pmatrix}

=

T\begin{pmatrix}
x\\
y\\
z\\
\end{pmatrix}
.
Rx(−p)⋅Ry(−q)⋅Rz(θ)⋅Ry(q)⋅Rx(p)
.
T\begin{pmatrix}
-x\\
-y\\
-z\\
\end{pmatrix}
$$


因此在处理围绕非坐标轴旋转的模型时，根据指定的旋转参数可以直接按照上述公式生成按照指定轴旋转的旋转矩阵，参加模型矩阵的构建。

齐次坐标还有一个优点，能够区分点和向量：在普通坐标里，点和向量都是由三个分量组成的，表示位置的点坐标（2，3，4）和表示方向的向量（2，3，4）没有区别。而在齐次坐标中，第四个分量可以区分它们，点坐标的第四个分量为1，而向量坐标第四个分量为0。比如，平移一个点是有意义的，能够得到平移后的点坐标；而平移一个向量是没有意义的，方向不会因为平移而改变。

以上，我们已经了解到模型矩阵可以存储一个模型空间位置变化的信息，在生成三维动画每一帧的过程中，**我们首先计算每个模型的模型矩阵，然后将最初的模型的每一顶点坐标都左乘该模型矩阵，得到这一帧表示的时刻（模型已经经过多次变换）该模型每一顶点的坐标**。上面说的“帧”并不狭义地指屏幕的两次刷新时间的短暂间隔中屏幕上呈现的图像，而是指在这幅图像所描绘的整个三维空间的这个瞬间的所有顶点的位置。

来看个具体的例子：一个绕z轴匀速螺旋匀速上升的立方体，在某一帧中（即在这一帧对应的时刻t下），其向z轴正方向平移的长度和绕z轴旋转的角度分别为：

t_z=t⋅vt,θz=t⋅ωt

则模型矩阵（注意上文齐次坐标下的基本变换矩阵）为：
$$
mMatrix=Rz(θz)⋅T(0,0,tz)=
\begin{bmatrix}
cosθz & -sinθz & 0 & 0\\
sinθz & cosθz & 0 & 0\\
0 & 0 & 1 & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & 0\\
0 & 1 & 0 & 0\\
0 & 0 & 1 & tz\\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$


产生这一帧时，只需要计算一次模型矩阵，再将立方体中8个顶点坐标分别左乘该矩阵，就可以得到经过变换后8个顶点的坐标。当一个模型顶点数量增加到上百甚至上千个，模型变换的步骤数也增加到几十步时，模型矩阵的作用就很明显了：如果没有齐次坐标（也当然没有模型矩阵），对每个顶点都需要一步一步地变换：平移的时候加上一个向量，旋转的时候左乘一个矩阵，才能得到变换后的顶点坐标；而模型变换只需要计算一次模型矩阵（当然也是一步一步的），然后每个顶点左乘模型矩阵就可以直接得到变换后的坐标了。

## **视图矩阵**

在模型矩阵中，我们关心的是空间中的点在经历变换后在世界坐标系下的位置。事实上，我们更加关心空间中的点相对于观察者的位置。最简单的方案是将观察者置于原点处，面向z轴（或x轴、y轴）正半轴，那么空间中的点在世界坐标系下的位置就是其相对于观察者的位置。
观察者的位置和方向会变化，看上去就好像整个世界的位置和方向发生变化了一样，所以解决的方案很简单，**将世界里的所有模型看作一个大模型，在所有模型矩阵的左侧再乘以一个表示整个世界变换的模型矩阵**，就可以了。这个表示整个世界变换的矩阵又称为“**视图矩阵**”，因为他们经常一起工作，所以将**视图矩阵乘以模型矩阵得到的矩阵称为“模型视图矩阵”**。模型视图矩阵的作用是：乘以一个点坐标，获得一个新的点坐标，获得的点坐标表示点在世界里变换，观察者也变换后，点相对于观察者的位置。

视图矩阵同样也可以分为平移、旋转和缩放，视图矩阵是将观察者视为一个模型，获得的观察者在世界中变换的模型矩阵的逆矩阵。

观察者平移了（t_x，t_y，t_z），视图矩阵如下，可以看出如果将视图矩阵看作整个世界的模型矩阵，相当于整个世界平移了（-t_x，-t_y，-t_z）。

$$
\begin{bmatrix}
1 & 0 & 0 & t_x\\
0 & 1 & 0 & t_y\\
0 & 0 & 1 & t_z\\
0 & 0 & 0 & 1\\
\end{bmatrix}^{-1}
=
\begin{bmatrix}
1 & 0 & 0 & -t_x\\
0 & 1 & 0 & -t_y\\
0 & 0 & 1 & -t_z\\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$
观察者绕z轴旋转了角度θ，视图矩阵如下，相当于整个世界绕z轴旋转了-θ度。
$$
\begin{bmatrix}
cosθ & -sinθ & 0 & 0\\
sinθ & cosθ & 0 & 0\\
0 & 0 & 1 & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}^{-1}
=
\begin{bmatrix}
cosθ & sinθ & 0 & 0\\
-sinθ & cosθ & 0 & 0\\
0 & 0 & 1 & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$
观察者在三个方向等比例缩小了s倍，视图矩阵如下，相当于整个世界放大了s倍。

$$
\begin{bmatrix}
s_x & -0 & 0 & 0\\
0 & s_y & 0 & 0\\
0 & 0 & s_z & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}^{-1}
=
\begin{bmatrix}
\frac{1}{s_x} & 0 & 0 & 0\\
-0 & \frac{1}{s_y} & 0 & 0\\
0 & 0 & \frac{1}{s_z} & 0\\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$
观察者缩小的情形可能会引起困惑：如果人和猫咪的眼睛在同一个位置，人看到的世界和一只猫咪看到的世界应当是一样尺寸的，这和上述视图矩阵的情形矛盾；但是直觉告诉我，如果你喝了缩小药水，你应该会觉得整个世界在膨胀，就像视图矩阵所表现的那样。解答是这样：如果在计算机上模拟观察者喝了缩小药水的情形，在屏幕上看到整个世界是膨胀的，因为在那个虚拟的三维空间中，计算机屏幕这个“窗口”也随你（观察者）缩小。
视图矩阵实际上就是整个世界的模型矩阵，这给我一点启发：一个模型可能由多个较小的子模型组成，模型自身有其模型矩阵，而子模型也有自己的局部模型矩阵。考虑一辆行驶中的汽车的轮胎，其模型视图矩阵是局部模型矩阵（描述轮胎的旋转）左乘汽车的模型矩阵（描述汽车的行驶）再左乘视图矩阵得到的。

## **投影矩阵**

模型视图矩阵的作用是确定某一帧中，空间里每个顶点的坐标，而投影矩阵则将这些顶点坐标映射到二维的屏幕上，即：

$$
\begin{bmatrix}
x\\
y\\
z\\
1\\
\end{bmatrix}
→
\begin{bmatrix}
x^′\\
y^′\\
\end{bmatrix}
$$
最主要的有两种投影方式，**正射投影**和**透视投影**。前者用于精确制图，如工业零件侧视图或建筑物顶视图，从屏幕上就可以量测平行于屏幕的线段长度；后者用于模拟视觉，远处的物体看上去较小。下图中，空间中的同一个矩形，正射投影后仍然是矩形，而透视投影后则变成了梯形。

正射投影（投影面和相机空间）：

![动图](https://pic3.zhimg.com/v2-44ec278ed6d171ca64f44308c6f48596_b.webp)



透视投影（投影面和相机空间）：

![动图封面](https://pic3.zhimg.com/v2-bc045590505e791a634479237f80f16e_b.jpg)



三维世界的显示中，屏幕模拟了一个窗口，你透过这个窗口观察“外面”的世界。你的屏幕是有边缘的（除非你有一个球形的房间，内壁全是屏幕），因此**你仅仅能观察到那个世界的一部分，即“相机空间”**。相机空间的左、右、上、下边界是受限于屏幕的边缘，同时也设定前、后边界，因为你很难看清太近或太远的东西。在正射投影中，相机空间是一个规则的立方体，而在透视投影中则是一个方台体。
三维模型可能在不同的显示器上展现，因此投影的过程中不该将显示器参数加入进来，而是将空间中的点投影到一个规范的显示器中。另外，透视投影中的z值并不是毫无用处，它可以用来表示顶点的“深度”：如果三维空间中的两个不同顶点投影到平面上时重合了，那么将显示深度较浅的顶点。

定义一个**规范的视窗区域（CCV），为x，y，z都处在区间[-1,1]之间的边长为2的立方体**。x和y坐标值用来线形拉伸到到实际屏幕上，而z值存储了“深度”。而投影的过程就是将三维空间中的点从相机空间映射到CCV中。
正射投影非常简单，直接将矩形的相机空间线形压缩到CCV中即可。采取顶视图，相机空间的左右边界为 $x_{left}$ 和 $x_{right}$ :

![动图封面](https://pic4.zhimg.com/v2-9e4aae476de67663450fde6f672f3d63_b.jpg)



简单的线形成比例关系：
$$
\frac{x-x_{left}}{x_{right}-x_{right}}
=
\frac{x^′ - (-1)}{1-(-1)}
$$

$$
x′ = 
\frac{2}{x_{right}-x_{right}}
.x
-
\frac{x_{right} + x_{left}}{x_{right} - x_{left}}
$$

推广到y轴和z轴：

$$
\begin{bmatrix}
x^′\\
y^′\\
z^′\\
1
\end{bmatrix}
=
\begin{bmatrix}
\frac{2}{x_{right} - x_{left}} & 0 & 0 & -\frac{x_{right} + x_{left}}{x_{right} - x_{left}}\\
0 & \frac{2}{y_{top} - y_{bottom}} & 0 & -\frac{y_{top} + y_{bottom}}{y_{top} - y_{bottom}}\\
0 & 0 & \frac{2}{z_{back} - z_{front}} & -\frac{z_{back} + z_{front}}{z_{back}- y_{front}}\\
0 & 0 & 0 & 1\\
\end{bmatrix}
.
\begin{bmatrix}
x\\
y\\
z\\
1
\end{bmatrix}
$$
相机空间中的点经过正射投影矩阵左乘后得到的点都在CCV之中：

$$
\begin{matrix}
-1 < x^′ < 1\\
-1 < y^′ < 1\\
-1 < z^′ < 1\\
\end{matrix}
$$
透视投影相对较为复杂，同样用顶视图考虑x坐标的情况：

$$
\frac{x_p}{h}
=
\frac{x}{z}
$$

$$
\frac{x_p - x_{left}}{x_{right} - x_{left}}
=
\frac{x^′-(-1)}{x-(-1)}
$$

$$
x^′
=
\frac{1}{z}
.
\frac{2h}{x_{right} - x_{left}}
-
\frac{x_{right} + x_{left}}{x_{right} - x_{left}}
$$

![动图封面](https://pic1.zhimg.com/v2-c75810c847a13438285d0e998e060e60_b.jpg)





转化为齐次的方式：
$$
z⋅x^′
=
x
.
\frac{2h}{x_{right} - x_{left}}
-
\frac{x_{right} + x_{left}}{x_{right} - x_{left}}
$$
推广到y轴：
$$
\begin{bmatrix}
z.x^′\\
z.y^′\\
z.z^′\\
z
\end{bmatrix}
=
\begin{bmatrix}
\frac{2}{x_{right} - x_{left}} & 0 & -\frac{x_{right} + x_{left}}{x_{right} - x_{left}} & 0\\
0 & \frac{2}{y_{top} - y_{bottom}} & -\frac{y_{top} + y_{bottom}}{y_{top} - y_{bottom}} & 0\\
0 & 0 & t_z & s_z\\
0 & 0 & 1 & 0\\
\end{bmatrix}
.
\begin{bmatrix}
x\\
y\\
z\\
1
\end{bmatrix}
$$


透视投影矩阵的第三行不是我们关心的内容，只要保证不同顶点投影前后的点坐标的第三个分量z和z’的大小关系不变就可以。

透视投影矩阵尾行是（0，0，1，0），这样就将计算得到的坐标的第四个分量赋值为z而不是1。将相机空间左乘投影矩阵后的结果不是一个CCV空间，如果你将这个空间画出来，会发现其仍然是一个方台形。这时进行“透视除法”，将上一步得到的点坐标化为第四个分量为1的标准齐次坐标：

$$
\begin{bmatrix}
x^′\\
y^′\\
z^′\\
1
\end{bmatrix}
=
\begin{bmatrix}
z.x^′\\
z.y^′\\
z.z^′\\
z^′
\end{bmatrix}
.
\frac{1}{z}
$$
然后我们直接取齐次坐标中的x’和y’值，并将其线形映射到屏幕上，比如点（0，0）出现在屏幕中央，点（-1，1）出现在屏幕左上角。



